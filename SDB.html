<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME4261</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  justify-content:center;
  padding:20px 10px 80px;
}
  .initial-loading{
  color:#1565c0;     /* BLUE */
  font-weight:700;
  text-align:center;
}
.page{width:100%;max-width:520px}
.card{
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 20px 50px rgba(0,0,0,.28);
}
.header{text-align:center}
.header h1{margin:0;color:#203a43;font-size:22px}
.header h2{margin:6px 0 0;font-size:14px;color:#666}

.infoBox{
  background:#f5f7fa;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  text-align:center;
  font-weight:600;
}

.attendanceValue{font-size:26px;font-weight:800;margin-top:8px}
.attendance-good{color:#1b5e20}
.attendance-bad{color:#b71c1c}

button{
  width:100%;
  padding:13px;
  margin-top:12px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
/* ANNOUNCEMENT BOX */
/* ANNOUNCEMENT BOX – LIGHT RED WITH DARK BORDER */
.announcementBox{
  background:#fdecea;              /* Light red */
  border:2px solid #b71c1c;        /* Dark red border */
  padding:16px;
  border-radius:14px;
  margin-top:14px;
  line-height:1.6;
  animation:announcementBlink 1.5s infinite;
}

/* Title (Black + Bold) */
.announcementTitle{
  text-align:center;
  font-weight:800;
  font-size:16px;
  color:#000;                 /* Black */
  margin-bottom:10px;
}

.announcementContent{
  color:#b71c1c;               /* Dark red */
  font-weight:600;
}

/* Subtle border glow animation */
@keyframes announcementBlink{
  0%{ box-shadow:0 0 0 rgba(183,28,28,.2); }
  50%{ box-shadow:0 0 18px rgba(183,28,28,.8); }
  100%{ box-shadow:0 0 0 rgba(183,28,28,.2); }
}
/* BUTTON COLORS */
.btn-tests{
  background:#3949ab;        /* Indigo */
  color:#fff;
}
.btn-tests:hover{
  background:#283593;
}
.btn-results{background:#00897b;color:#fff}
.btn-attendance{
  background:#ffb74d;
  color:#fff;
}
.btn-attendance:hover{
  background:#ffa726;
}
.btn-logout{background:#c62828;color:#fff}

.dropdown{margin-top:10px;display:none}
.loading{
  color:#c62828;        /* RED */
  font-weight:700;
  text-align:center;
  margin-top:10px;
}

.box{
  padding:12px;
  border-radius:12px;
  margin-top:10px;
  font-weight:600;
}
.present{background:#e8f5e9;color:#1b5e20}
.absent{background:#fdecea;color:#b71c1c}
.attendanceBox{
  padding:14px;
  border-radius:14px;
  font-weight:600;
}
.mock-active{
  background:#ffcdd2;        /* Light red */
  border:2px solid #c62828;  /* Dark red border */
  color:#b71c1c;             /* Dark red text */
  cursor:pointer;
  font-weight:800;
}

.presentBox{
  background:#e8f5e9;
  border:1px solid #c8e6c9;
  color:#1b5e20;
}

.absentBox{
  background:#fdecea;
  border:1px solid #f5c6cb;
  color:#b71c1c;
}

.dateChip{
  display:inline-block;
  padding:6px 10px;
  margin:6px 6px 0 0;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}
.scoreBox{
  display:inline-block;
  background:#e8f5e9;
  color:#1b5e20;
  padding:10px 18px;
  border-radius:14px;
  font-weight:800;
  font-size:18px;
  border:2px solid #2e7d32;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
.dateGreen{
  background:#c8e6c9;
  color:#1b5e20;
}
.testsContainer{
  background:#e8f5e9;          /* light green */
  border-radius:20px;
  padding:20px;
  margin-top:14px;
  box-shadow:0 12px 35px rgba(0,0,0,.25);
}

/* BASE TEST BUTTON */
.testBtn{
  width:100%;
  padding:13px;                 /* same as main buttons */
  margin-bottom:10px;
  border-radius:30px;           /* same shape as buttons */
  font-size:15px;               /* same font size */
  font-weight:700;
  border:none;
  text-align:center;
  cursor:default;
  box-shadow:0 6px 14px rgba(0,0,0,.18);
}
.testsContainer{
  background:#e8f5e9;
  border-radius:18px;
  padding:14px;     /* reduced */
  margin-top:10px;
}
/* ACTIVE TEST */
.test-active{
  background:#c62828;          /* RED */
  color:#fff;
  cursor:pointer;
  animation:blink 1.3s infinite;
}

/* COMPLETED TEST */
.test-completed{
  background:#2e7d32;          /* GREEN */
  color:#fff;
}

/* UPCOMING TEST */
.test-upcoming{
  background:#fff9c4;          /* PALE YELLOW */
  color:#555;
}
.resultPanel{
  display:none;
  margin-top:10px;
  background:#f5f7fa;
  border-radius:14px;
  padding:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}
.btn-downloads{
  background:#6a1b9a;   /* Purple */
  color:#fff;
}
.btn-downloads:hover{
  background:#4a148c;
}
.resultMarks{
  font-size:22px;
  font-weight:800;
  color:#1b5e20;
  text-align:center;
  margin-bottom:12px;
}
@keyframes blink{
  0%{ box-shadow:0 0 0 rgba(198,40,40,.4); }
  50%{ box-shadow:0 0 18px rgba(198,40,40,1); }
  100%{ box-shadow:0 0 0 rgba(198,40,40,.4); }
}
  #mockLoadingOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.dateRed{
  background:#ffcdd2;
  color:#b71c1c;
}
 #resultLoadingOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;        /* default hidden */
  align-items:center;
  justify-content:center;
  z-index:9999;
}
  #logoutOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
/* SMALL DOWNLOAD BUTTON */
.downloadBtn{
  padding:9px 14px;
  font-size:13px;
  border-radius:20px;
}
.logoutBox{
  background:#fff;
  padding:24px 28px;
  border-radius:16px;
  text-align:center;
  font-weight:700;
  color:#555;
  box-shadow:0 12px 30px rgba(0,0,0,0.25);
}
.btn-view{
  width:100%;
  background:#3949ab;   /* Indigo */
  color:#fff;
  padding:12px;
  border:none;
  border-radius:30px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
}

.btn-view:hover{
  background:#283593;
}
.logoutSpinner{
  width:36px;
  height:36px;
  margin:0 auto 12px;
  border:4px solid #eee;
  border-top:4px solid #c62828;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
  .resultInfo{
  text-align:left;
  font-weight:600;
  color:#1565c0;   /* Professional Blue */
  margin-bottom:6px;
}
  .option{
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:1px solid #ccc;
  cursor:pointer;
}

.option.correct{
  background:#e8f5e9;
  border:2px solid #2e7d32;
  color:#1b5e20;
}

.option.wrong{
  background:#fdecea;
  border:2px solid #c62828;
  color:#b71c1c;
}

.option.disabled{
  pointer-events:none;
}
.btn-view{
  background:#3949ab;      /* Indigo */
  color:#fff;
  padding:12px;
  border:none;
  border-radius:24px;
  font-weight:700;
  font-size:14px;
  cursor:pointer;
}
.resultValue{
  color:#1565c0;     /* Professional Blue */
  font-weight:700;
}
.btn-view:hover{
  background:#283593;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
footer{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#0f2027;
  color:#cfd8dc;
  text-align:center;
  padding:10px;
  font-size:13px;
  font-weight:600;
}
</style>
</head>

<body>
<div class="page">
<div class="card">

<div class="header">
  <h1>Energy Storage Technology</h1>
  <h2>ME4261</h2>
</div>

<div class="infoBox initial-loading" id="loadingBox">
  Fetching your details… Please wait
</div>

<div id="welcomeBox" style="display:none;margin-top:12px;text-align:center">
  <b id="welcomeText"></b>
</div>

<div id="contentArea" style="display:none">
<div class="announcementBox">
  <div class="announcementTitle">
    Syllabus for Mid-Sem
  </div>

  <div class="announcementContent">
    i) Types of thermal energy storage techniques<br>
    ii) Heat pipes<br>
    iii) Vapour chambers
  </div>
</div>
<div class="infoBox">
  Current Attendance Percentage
  <div id="attendanceValue" class="attendanceValue">—</div>
</div>

<!-- CLASS TESTS -->
<button class="btn-tests" onclick="toggleClassTests()">Class Tests</button>
<div id="testsLoading" class="loading" style="display:none">Loading… Please wait</div>
<div id="testsBox" class="testsContainer" style="display:none"></div>

<!-- RESULTS -->
<button class="btn-results" onclick="toggleResults()">Check Results</button>
<div id="resultsLoading" class="loading" style="display:none">Loading… Please wait</div>
<div id="resultsBox" class="testsContainer" style="display:none"></div>

  <!-- MOCK TESTS -->
<button class="btn-tests" onclick="toggleMockTests()">
  Mock Tests
</button>

<div id="mockLoading" class="loading" style="display:none">
  Loading… Please wait
</div>

<div id="mockBox" class="testsContainer" style="display:none"></div>
  
<!-- DOWNLOADS -->
<button class="btn-downloads" onclick="toggleDownloads()">
  Downloads
</button>
<div id="downloadsLoading" class="loading" style="display:none">
  Loading… Please wait
</div>
<div id="downloadsBox" class="testsContainer" style="display:none"></div>
<!-- ATTENDANCE -->
<button class="btn-attendance" onclick="toggleAttendance()">
  View Attendance Details
</button>
<div id="attendanceLoading" class="loading" style="display:none">
  Loading… Please wait
</div>
<div id="attendanceBox" style="display:none; margin-top:16px;">

  <div class="attendanceBox presentBox">
    <b>Present</b>
    <div id="presentDates"></div>
  </div>

  <div class="attendanceBox absentBox" style="margin-top:12px">
    <b>Absent</b>
    <div id="absentDates"></div>
  </div>

</div>

<button class="btn-logout" onclick="logout()">Logout</button>

</div>
</div>
</div>

<footer>
Developed by Dr. Rajesh Akula  
<div>© 2026 · IIEST Shibpur</div>
</footer>
<script src="config.js"></script>
<script>
  
const BACKEND=BACKEND_URL;
const token=sessionStorage.getItem("token");
if(!token){
  location.replace("index.html");
}  
const testsBox = document.getElementById("testsBox");
const resultsBox = document.getElementById("resultsBox");
const attendanceBox = document.getElementById("attendanceBox");
const testsLoading = document.getElementById("testsLoading");
const resultsLoading = document.getElementById("resultsLoading");
  const downloadsBox = document.getElementById("downloadsBox");
const downloadsLoading = document.getElementById("downloadsLoading");
  const mockBox = document.getElementById("mockBox");
const mockLoading = document.getElementById("mockLoading");
  const params = new URLSearchParams(location.search);
const mockId = params.get("mock");
const mode = params.get("mode"); // fresh or review
function closeAll(){
  testsBox.style.display="none";
  resultsBox.style.display="none";
  attendanceBox.style.display="none";
  downloadsBox.style.display="none";
  mockBox.style.display="none";   // ADD THIS
  attendanceOpen = false;
}

Promise.all([
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"dashboard",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyAttendance",token})}).then(r=>r.json())
]).then(([d,a])=>{

  if(d.status !== "OK"){
    sessionStorage.clear();
    location.replace("index.html");
    return;
  }

  loadingBox.style.display="none";
  contentArea.style.display="block";
  welcomeBox.style.display="block";
  welcomeText.innerHTML=`Welcome <span style="color:#1b5e20">${d.name} (${d.roll})</span>`;
  attendanceValue.innerText=a.percent+"%";
  attendanceValue.className="attendanceValue "+(a.percent>=75?"attendance-good":"attendance-bad");
});

let attendanceOpen = false;

function toggleAttendance(){

  const box = attendanceBox;
  const loader = document.getElementById("attendanceLoading");

  // If already open → close
  if(attendanceOpen){
    box.style.display = "none";
    loader.style.display = "none";
    attendanceOpen = false;
    return;
  }

  closeAll();                 // close other dropdowns
  attendanceOpen = true;

  // SHOW loader, HIDE content
  loader.style.display = "block";
  box.style.display = "none";

  presentDates.innerHTML = "";
  absentDates.innerHTML  = "";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getMyAttendanceDetails",
      token
    })
  })
  .then(r=>r.json())
  .then(res=>{

    loader.style.display = "none";
    box.style.display = "block";

    if(res.status !== "OK"){
      presentDates.innerHTML = "<i>No data</i>";
      absentDates.innerHTML  = "<i>No data</i>";
      return;
    }

    renderDates(presentDates, res.attended, "dateGreen");
    renderDates(absentDates,  res.absent,   "dateRed");
  });
}
  function toggleDownloads(){

  if(downloadsBox.style.display === "block"){
    downloadsBox.style.display = "none";
    return;
  }

  closeAll();
  downloadsLoading.style.display = "block";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getDownloads",
      token
    })
  })
  .then(r=>r.json())
  .then(res=>{
    downloadsLoading.style.display = "none";
    downloadsBox.style.display = "block";

    if(res.status !== "OK" || !res.files || !res.files.length){
      downloadsBox.innerHTML = `
        <div class="testBtn test-upcoming">
          No files available
        </div>
      `;
      return;
    }

    downloadsBox.innerHTML = res.files.map(f => `
  <div class="testBtn test-completed downloadBtn"
       onclick="downloadFile('${f.url}')"
       style="cursor:pointer">
    ${f.name}
    <div style="font-size:11px;margin-top:3px">
      Click to Download
    </div>
  </div>
`).join("");
  });
}
 function downloadFile(url){
  const a = document.createElement("a");
  a.href = url;
  a.target = "_blank";
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
function renderDates(container, list, cls){
  if(!list || !list.length){
    container.innerHTML = "<i>No records</i>";
    return;
  }

  container.innerHTML = list
    .map(d => `<span class="dateChip ${cls}">${prettyDate(d)}</span>`)
    .join("");
}
function toggleClassTests(){
  if(testsBox.style.display==="block"){
    testsBox.style.display="none";
    return;
  }

  closeAll();
  testsLoading.style.display="block";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getStudentTestStatus",
      token
    })
  })
  .then(r=>r.json())
  .then(res=>{
    testsLoading.style.display="none";
    testsBox.style.display="block";

    testsBox.innerHTML = res.tests.map(t => {

  /* CASE 1: Student already attempted */
  if (t.attempted) {
  return `
    <div class="testBtn test-completed">
      ${t.name} (COMPLETED)
      <div style="font-size:12px;font-weight:600;margin-top:4px">
        Test conducted on: ${t.completionDate}
      </div>
    </div>
  `;
}

  /* CASE 2: Student is enabled → allow start (MOST IMPORTANT) */
  if (t.enabled) {
    return `
      <div class="testBtn test-active"
           onclick="startTestConfirm('${t.id}')">
        ${t.name} (START TEST)
      </div>
    `;
  }

 /* CASE 3: Test conducted (anyone attempted) */
if (t.globallyAttempted) {
  return `
    <div class="testBtn test-completed">
      ${t.name} (COMPLETED)
      <div style="font-size:12px;font-weight:600;margin-top:4px">
        Test conducted on: ${t.completionDate || "-"}
      </div>
    </div>
  `;
}

  /* CASE 4: Test not started yet */
  return `
    <div class="testBtn test-upcoming">
      ${t.name} (UPCOMING)
    </div>
  `;

}).join("");
  });
}
  function startTestConfirm(testId){
  const ok = confirm(
    "Are you sure you want to start the test?\n\n" +
    "• Test timer will start immediately\n" +
    "• You cannot reattempt\n" +
    "• Leaving the page will auto-submit"
  );

  if(!ok) return;

  // Optional UX polish
  testsLoading.style.display = "block";

  // Small delay = smoother UX
  setTimeout(()=>{
    location.href = `test.html?test=${testId}`;
  }, 300);
}
function prettyDate(d){
  const dt = new Date(d);
  const day = dt.getDate();
  const suf =
    day % 10 === 1 && day !== 11 ? "st" :
    day % 10 === 2 && day !== 12 ? "nd" :
    day % 10 === 3 && day !== 13 ? "rd" : "th";

  return `${day}${suf} ${dt.toLocaleString("en",{month:"short"})} ${dt.getFullYear()}`;
}
function toggleResults(){
  if(resultsBox.style.display==="block"){
    resultsBox.style.display="none";
    return;
  }

  closeAll();
  resultsLoading.style.display="block";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getStudentTestStatus",
      token
    })
  })
  .then(r=>r.json())
  .then(res=>{
    resultsLoading.style.display="none";
    resultsBox.style.display="block";

    resultsBox.innerHTML = res.tests.map(t => `
      <div class="testBlock">
        <div class="testBtn ${
  t.evaluated ? "test-completed" : "test-upcoming"
}"
${t.evaluated ? `onclick="toggleResultPanel('${t.id}')"` : ""}>
          ${t.name}
          ${t.evaluated ? "" : " (Not Published)"}
        </div>

        <div id="result_${t.id}" class="resultPanel">
          ${
            t.evaluated
            ? `
           <div style="text-align:center;margin-bottom:12px">
  <div class="scoreBox">
    Marks: ${t.score} / ${t.total}
  </div>
</div>
 <div style="text-align:left;margin-bottom:6px">
   Test conducted on: 
   <span class="resultValue">${t.completionDate || "-"}</span>
 </div>
 <div style="text-align:left;margin-bottom:6px">
   Maximum marks obtained: 
   <span class="resultValue">${t.maxScore}</span>
 </div>

 <div style="text-align:left;margin-bottom:10px">
   Class average: 
   <span class="resultValue">${t.avgScore}</span>
 </div>

 <button class="btn-view"
   onclick="openAnswerSheet('${t.id}')">
   View Answer Sheet
 </button>
`
            : `
              <div style="text-align:center;font-weight:600;color:#777">
                Results not published yet
              </div>
            `
          }
        </div>
      </div>
    `).join("");
  });
}
  function toggleMockTests(){

  if(mockBox.style.display === "block"){
    mockBox.style.display = "none";
    return;
  }

  closeAll();
  mockLoading.style.display = "block";

  // Since only 2 static mock tests
  setTimeout(()=>{
    mockLoading.style.display = "none";
    mockBox.style.display = "block";

    mockBox.innerHTML = `
      <div class="testBtn mock-active"
           onclick="handleMockClick('mock1')">
        Mock Test – I
      </div>

      <div class="testBtn mock-active"
           onclick="handleMockClick('mock2')">
        Mock Test – II
      </div>
    `;
  }, 300);
}
function handleMockClick(mockId){

  // Disable all buttons
  document.querySelectorAll("button").forEach(btn=>{
    btn.disabled = true;
    btn.style.opacity = "0.6";
  });

  // Show loading overlay
  document.getElementById("mockLoadingOverlay").style.display = "flex";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"checkMockAttempt",
      token,
      mockId
    })
  })
  .then(r=>r.json())
  .then(res=>{

    if(res.attempted){

      // Hide overlay before confirm
      document.getElementById("mockLoadingOverlay").style.display = "none";

      const reattempt = confirm(
        "You completed this mock test.\n\n" +
        "Would you like to Reattempt?"
      );

      if(!reattempt){
        // Re-enable buttons
        document.querySelectorAll("button").forEach(btn=>{
          btn.disabled = false;
          btn.style.opacity = "1";
        });
        return;
      }

      // Show overlay again for reset + redirect
      document.getElementById("mockLoadingOverlay").style.display = "flex";

      fetch(BACKEND,{
        method:"POST",
        body:new URLSearchParams({
          action:"resetMock",
          token,
          mockId
        })
      })
      .then(r=>r.json())
      .then(resp=>{
        if(resp.status === "RESET"){
          location.href = `mocktest.html?mock=${mockId}&mode=fresh`;
        } else {
          alert("Unable to reset mock. Please try again.");
          location.reload();
        }
      });

    }
    else{
      location.href = `mocktest.html?mock=${mockId}&mode=fresh`;
    }

  })
  .catch(()=>{
    alert("Network error. Please try again.");
    location.reload();
  });
}
  function toggleResultPanel(testId){
  document.querySelectorAll(".resultPanel").forEach(p=>{
    if(p.id !== "result_" + testId){
      p.style.display = "none";
    }
  });

  const panel = document.getElementById("result_" + testId);
  if(!panel) return;

  panel.style.display =
    panel.style.display === "block" ? "none" : "block";
}
  function showResultDetails(testId, score){
  resultsBox.innerHTML = `
    <div class="box" style="background:#e8f5e9">
      <b>Marks</b><br><br>
      <div style="font-size:22px;font-weight:800;color:#1b5e20">
        ${score}
      </div><br>

      <button class="btn-view"
        onclick="location.href='results.html?test=${testId}'">
        View Answer Sheet
      </button>
    </div>

    <button class="btn-results"
      style="margin-top:12px"
      onclick="toggleResults()">
      ← Back to Results
    </button>
  `;
}

 function openAnswerSheet(testId){

  // Disable buttons
  document.querySelectorAll("button").forEach(btn=>{
    btn.disabled = true;
    btn.style.opacity = "0.6";
  });

  // Show overlay
  document.getElementById("resultLoadingOverlay").style.display = "flex";

  // Navigate immediately
  location.href = `results.html?test=${testId}`;
}
function logout(){

  if(!confirm("Are you sure you want to logout?")) return;

  // Disable all buttons
  document.querySelectorAll("button").forEach(btn=>{
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.style.cursor = "not-allowed";
  });

  // Show overlay
  document.getElementById("logoutOverlay").style.display = "flex";

  // Call backend logout
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"logout",
      token
    })
  })
  .finally(()=>{
    sessionStorage.clear();
    location.replace("index.html");
  });
}
</script>
  <div id="logoutOverlay" style="display:none">
  <div class="logoutBox">
    <div class="logoutSpinner"></div>
    Logging out… Please wait
  </div>
</div>
  <div id="resultLoadingOverlay">
  <div class="logoutBox">
    <div class="logoutSpinner"></div>
    Loading Answer Sheet… Please wait
  </div>
</div>
  <div id="mockLoadingOverlay" style="display:none">
  <div class="logoutBox">
    <div class="logoutSpinner"></div>
    Loading Mock Test… Please wait
  </div>
</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME4261</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  justify-content:center;
  padding:20px 10px 80px;
}
.page{width:100%;max-width:520px}
.card{
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 20px 50px rgba(0,0,0,.28);
}
.header{text-align:center}
.header h1{margin:0;color:#203a43;font-size:22px}
.header h2{margin:6px 0 0;font-size:14px;color:#666}

.infoBox{
  background:#f5f7fa;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  text-align:center;
  font-weight:600;
}

.attendanceValue{font-size:26px;font-weight:800;margin-top:8px}
.attendance-good{color:#1b5e20}
.attendance-bad{color:#b71c1c}

button{
  width:100%;
  padding:13px;
  margin-top:12px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}

/* BUTTON COLORS */
.btn-tests{background:#6a1b9a;color:#fff}
.btn-results{background:#00897b;color:#fff}
.btn-attendance{background:#1565c0;color:#fff}
.btn-logout{background:#c62828;color:#fff}

.dropdown{margin-top:10px;display:none}
.loading{color:#1565c0;font-weight:700;text-align:center;margin-top:10px}

.box{
  padding:12px;
  border-radius:12px;
  margin-top:10px;
  font-weight:600;
}
.present{background:#e8f5e9;color:#1b5e20}
.absent{background:#fdecea;color:#b71c1c}

footer{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#0f2027;
  color:#cfd8dc;
  text-align:center;
  padding:10px;
  font-size:13px;
  font-weight:600;
}
</style>
</head>

<body>
<div class="page">
<div class="card">

<div class="header">
  <h1>Energy Storage Technology</h1>
  <h2>ME4261</h2>
</div>

<div class="infoBox" id="loadingBox">Fetching your details… Please wait</div>

<div id="welcomeBox" style="display:none;margin-top:12px;text-align:center">
  <b id="welcomeText"></b>
</div>

<div id="contentArea" style="display:none">

<div class="infoBox">
  Current Attendance Percentage
  <div id="attendanceValue" class="attendanceValue">—</div>
</div>

<!-- CLASS TESTS -->
<button class="btn-tests" onclick="toggleClassTests()">Class Tests</button>
<div id="testsLoading" class="loading" style="display:none">Loading… Please wait</div>
<div id="testsBox" class="dropdown"></div>

<!-- RESULTS -->
<button class="btn-results" onclick="toggleResults()">Check Results</button>
<div id="resultsLoading" class="loading" style="display:none">Loading… Please wait</div>
<div id="resultsBox" class="dropdown"></div>

<!-- ATTENDANCE -->
<button class="btn-attendance" onclick="toggleAttendance()">View Attendance Details</button>
<div id="attendanceBox" class="dropdown">
  <div class="box present">
    <b>Present</b>
    <div id="presentDates"></div>
  </div>
  <div class="box absent">
    <b>Absent</b>
    <div id="absentDates"></div>
  </div>
</div>

<button class="btn-logout" onclick="logout()">Logout</button>

</div>
</div>
</div>

<footer>
Developed by Dr. Rajesh Akula  
<div>© 2026 · IIEST Shibpur</div>
</footer>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbzVJ2lMkwvArC8f8cTgKVsNuWXOxVAQnkmNWZH7NzdOGQvgIyDjKU9NVRXhSdmiDes5/exec";
const token=sessionStorage.getItem("token");

function closeAll(){
  ["testsBox","resultsBox","attendanceBox"].forEach(id=>{
    document.getElementById(id).style.display="none";
  });
}

Promise.all([
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"dashboard",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyAttendance",token})}).then(r=>r.json())
]).then(([d,a])=>{
  loadingBox.style.display="none";
  contentArea.style.display="block";
  welcomeBox.style.display="block";
  welcomeText.innerHTML=`Welcome <span style="color:#1b5e20">${d.name} (${d.roll})</span>`;
  attendanceValue.innerText=a.percent+"%";
  attendanceValue.className="attendanceValue "+(a.percent>=75?"attendance-good":"attendance-bad");
});

function toggleAttendance(){
  const box=attendanceBox;
  if(box.style.display==="block"){ box.style.display="none"; return; }
  closeAll();
  box.style.display="block";

  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyAttendanceDetails",token})})
  .then(r=>r.json())
  .then(res=>{
    presentDates.innerHTML=res.attended.join("<br>")||"—";
    absentDates.innerHTML=res.absent.join("<br>")||"—";
  });
}

function toggleClassTests(){
  if(testsBox.style.display==="block"){ testsBox.style.display="none"; return; }
  closeAll();
  testsLoading.style.display="block";
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getStudentTestStatus",token})})
  .then(r=>r.json())
  .then(res=>{
    testsLoading.style.display="none";
    testsBox.style.display="block";
    testsBox.innerHTML=res.tests.map(t=>{
      if(t.attempted) return `${t.name} (Completed)`;
      if(t.enabled) return `<button class="btn-tests" onclick="location.href='test.html?test=${t.id}'">${t.name} – START</button>`;
      return `${t.name} (Upcoming)`;
    }).join("<br>");
  });
}

function toggleResults(){
  if(resultsBox.style.display==="block"){ resultsBox.style.display="none"; return; }
  closeAll();
  resultsLoading.style.display="block";
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getStudentTestStatus",token})})
  .then(r=>r.json())
  .then(res=>{
    resultsLoading.style.display="none";
    resultsBox.style.display="block";
    const e=res.tests.filter(t=>t.evaluated);
    resultsBox.innerHTML=e.length
      ? e.map(t=>`<button class="btn-results" onclick="location.href='results.html?test=${t.id}'">${t.name}</button>`).join("")
      : "Results not published yet";
  });
}

function logout(){
  sessionStorage.clear();
  location.replace("index.html");
}
</script>
</body>
</html>

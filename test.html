<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Class Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial;
  background:#f5f7fa;
  margin:0;
}
.header{
  background:#203a43;
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
}
.timer{color:#ffeb3b;}
.card{
  margin:14px;
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}
.option{
  margin-top:10px;
  padding:10px;
  border:1px solid #ccc;
  border-radius:10px;
}
button{
  margin-top:16px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:30px;
  font-size:16px;
  font-weight:700;
  background:#1b5e20;
  color:#fff;
}
</style>
</head>

<body>

<div class="header">
  <div id="qCount">Question</div>
  <div class="timer" id="timer">05:00</div>
</div>

<div class="card">
  <div id="question"></div>
  <div id="options"></div>
  <button id="nextBtn" onclick="next()">Next</button>
</div>

<script>
const BACKEND = "https://script.google.com/macros/s/AKfycbwrnoG0gWCDnNp4lVxL3UijYejgNzWT43FJQcutqM53wSmWTrOcuSlPRhh9BzPNnF4/exec";
const token = sessionStorage.getItem("token");
if(!token) location.replace("index.html");

const testId = new URLSearchParams(location.search).get("test");

let questions = [];
let index = 0;
let answers = {};
let endTime;

/* ===== START TEST ===== */
fetch(BACKEND,{
  method:"POST",
  body:new URLSearchParams({action:"startTest",token,testId})
})
.then(r=>r.json())
.then(res=>{
  if(res.status!=="STARTED"){
    alert("You cannot attempt this test");
    location.replace("student_dashboard.html");
    return;
  }
  loadQuestions();
});

/* ===== LOAD QUESTIONS ===== */
function loadQuestions(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getQuestions",testId})
  })
  .then(r=>r.json())
  .then(res=>{
    questions = res.questions;
    endTime = Date.now() + 5*60*1000;
    startTimer();
    render();
  });
}

/* ===== TIMER ===== */
function startTimer(){
  const t = setInterval(()=>{
    const diff = endTime - Date.now();
    if(diff<=0){
      clearInterval(t);
      submit(true);
      return;
    }
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);
    document.getElementById("timer").innerText =
      `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  },1000);
}

/* ===== RENDER ===== */
function render(){
  const q = questions[index];
  document.getElementById("qCount").innerText =
    `Q${index+1} / ${questions.length}`;
  document.getElementById("question").innerText = q.q;

  document.getElementById("options").innerHTML =
    ["A","B","C","D"].map(o=>`
      <div class="option">
        <label>
          <input type="radio" name="opt" value="${o}">
          ${q[o]}
        </label>
      </div>
    `).join("");

  if(index===questions.length-1)
    document.getElementById("nextBtn").innerText="Submit";
}

/* ===== NEXT ===== */
function next(){
  const sel = document.querySelector("input[name=opt]:checked");
  if(!sel){ alert("Select an option"); return; }

  answers[questions[index].id] = sel.value;
  index++;

  if(index>=questions.length){
    submit(false);
  }else{
    render();
  }
}

/* ===== SUBMIT ===== */
function submit(auto){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"submitTest",
      token,
      testId,
      auto: auto ? "1" : "0",
      answers: JSON.stringify(answers)
    })
  }).finally(()=>{
    alert("Test submitted");
    location.replace("student_dashboard.html");
  });
}

/* ===== AUTO SUBMIT TRIGGERS ===== */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden) submit(true);
});
window.addEventListener("beforeunload",()=>submit(true));
</script>

</body>
</html>

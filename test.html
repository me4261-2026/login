<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#f4f6f8;
  padding:14px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 12px 35px rgba(0,0,0,.25);
}
.timer{
  text-align:center;
  font-size:22px;
  font-weight:800;
  color:#c62828;
  margin-bottom:14px;
}
.question{
  font-weight:700;
  margin-bottom:12px;
}
.option{
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:2px solid #ddd;
  cursor:pointer;
}
.option.selected{
  border-color:#1565c0;
  background:#e3f2fd;
}
button{
  margin-top:18px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:30px;
  font-weight:700;
  font-size:16px;
  background:#1565c0;
  color:#fff;
}
button:disabled{
  background:#999;
}
</style>
</head>

<body>

<div class="card">
  <div class="timer" id="timer">--:--</div>
  <div class="question" id="questionText"></div>
  <div id="options"></div>
  <button id="nextBtn" onclick="next()">Next</button>
</div>

<script>
const BACKEND = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
const token = sessionStorage.getItem("token");
const testId = new URLSearchParams(location.search).get("test");

if(!token || !testId){
  alert("Invalid session");
  location.replace("index.html");
}

let questions=[], index=0, answers={}, selected=null;
let timeLeft=0, timerHandle;

/* ===== START TEST ===== */
fetch(BACKEND,{
  method:"POST",
  body:new URLSearchParams({
    action:"startTest",
    token,
    testId
  })
})
.then(r=>r.json())
.then(res=>{
  if(res.status!=="STARTED"){
    alert("You cannot attempt this test again");
    location.replace("student_dashboard.html");
    return;
  }
  timeLeft = res.duration * 60;
  startTimer();
  loadQuestions();
});

/* ===== LOAD QUESTIONS ===== */
function loadQuestions(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getQuestions",
      token,
      testId
    })
  })
  .then(r=>r.json())
  .then(res=>{
    questions = res.questions;
    render();
  });
}

/* ===== TIMER ===== */
function startTimer(){
  timerHandle = setInterval(()=>{
    timeLeft--;
    const m = Math.floor(timeLeft/60);
    const s = timeLeft%60;
    timer.innerText =
      `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

    if(timeLeft<=0){
      clearInterval(timerHandle);
      submit(true);
    }
  },1000);
}

/* ===== RENDER QUESTION ===== */
function render(){
  const q = questions[index];
  selected=null;

  questionText.innerText = `Q${index+1}. ${q.q}`;
  options.innerHTML = ["A","B","C","D"].map(o=>`
    <div class="option" onclick="pick('${o}',this)">
      ${o}. ${q[o]}
    </div>
  `).join("");

  nextBtn.innerText = (index===questions.length-1) ? "Submit" : "Next";
}

/* ===== PICK OPTION ===== */
function pick(v,el){
  document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
  el.classList.add("selected");
  selected = v;
}

/* ===== NEXT / SUBMIT ===== */
function next(){
  if(!selected){
    alert("Select an option");
    return;
  }

  answers[questions[index].id] = selected;

  if(index === questions.length-1){
    submit(false);
  }else{
    index++;
    render();
  }
}

/* ===== SUBMIT ===== */
function submit(auto){
  clearInterval(timerHandle);

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"submitTest",
      token,
      testId,
      auto: auto ? "1":"0",
      answers: JSON.stringify(answers)
    })
  }).finally(()=>{
    alert("Test submitted successfully");
    location.replace("student_dashboard.html");
  });
}

/* ===== AUTO SUBMIT RULES ===== */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden) submit(true);
});
window.addEventListener("beforeunload",()=>submit(true));
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#f4f6f8;
  padding:14px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 12px 35px rgba(0,0,0,.25);
}
.timer{
  text-align:center;
  font-size:20px;
  font-weight:800;
  color:#c62828;
  margin-bottom:14px;
}
.question{
  font-weight:700;
  margin-bottom:12px;
}
.option{
  padding:10px;
  margin-top:8px;
  border-radius:10px;
  border:2px solid #ddd;
  cursor:pointer;
}
.option.selected{
  border-color:#1565c0;
  background:#e3f2fd;
}
button{
  margin-top:16px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:30px;
  font-weight:700;
  font-size:15px;
  background:#1565c0;
  color:#fff;
}
button:disabled{ background:#999; }
</style>
</head>

<body>

<div class="card">
  <div class="timer" id="timer">05:00</div>
  <div class="question" id="questionText"></div>
  <div id="options"></div>
  <button id="nextBtn" onclick="next()">Next</button>
</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbwKqCMgfSruiboypah3chE2B4rg2pg9XjfItboXqJMBOpcdSCapNsioKicWWUGYTYQc/exec";

const token = sessionStorage.getItem("token");
const testId = new URLSearchParams(location.search).get("test");

if(!token || !testId){
  alert("Invalid session");
  location.replace("index.html");
}

let questions=[], idx=0, answers={}, selected=null;
let timeLeft=300, timerId, submitted=false;

/* START TEST */
fetch(BACKEND,{
  method:"POST",
  body:new URLSearchParams({action:"startTest", token, testId})
})
.then(r=>r.json())
.then(res=>{
  if(res.status!=="STARTED"){
    alert("You cannot attempt this test");
    location.replace("student_dashboard.html");
    return;
  }
  loadQuestions();
  startTimer();
});

/* LOAD QUESTIONS */
function loadQuestions(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getQuestions", token, testId})
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status!=="OK"){
      alert("Failed to load questions");
      location.replace("student_dashboard.html");
      return;
    }
    questions = res.questions;
    show();
  });
}

/* SHOW QUESTION */
function show(){
  const q = questions[idx];
  selected = null;

  questionText.innerText = `Q${idx+1}. ${q.q}`;
  options.innerHTML = ["A","B","C","D"].map(k=>`
    <div class="option" onclick="pick('${k}',this)">
      ${k}. ${q[k]}
    </div>
  `).join("");

  nextBtn.innerText = idx===questions.length-1 ? "Submit" : "Next";
}

/* PICK OPTION */
function pick(v,el){
  document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
  el.classList.add("selected");
  selected = v;
}

/* NEXT / SUBMIT */
function next(){
  if(!selected){ alert("Select an option"); return; }

  answers[questions[idx].id] = selected;

  if(idx===questions.length-1){
    submit(false);
  }else{
    idx++;
    show();
  }
}

/* TIMER */
function startTimer(){
  timerId = setInterval(()=>{
    timeLeft--;
    timer.innerText =
      `${String(Math.floor(timeLeft/60)).padStart(2,"0")}:${String(timeLeft%60).padStart(2,"0")}`;
    if(timeLeft<=0) submit(true);
  },1000);
}

/* SUBMIT */
function submit(auto){
  if(submitted) return;
  submitted = true;
  clearInterval(timerId);

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"submitTest",
      token,
      testId,
      auto: auto?"1":"0",
      answers: JSON.stringify(answers)
    })
  }).finally(()=>{
    alert("Test submitted successfully");
    location.replace("student_dashboard.html");
  });
}

/* TAB CLOSE / REFRESH */
window.addEventListener("beforeunload",()=>submit(true));
</script>

</body>
</html>
